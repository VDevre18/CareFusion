@page "/deleted-images"
@attribute [Authorize]
@using CareFusion.Model.Dtos
@using CareFusion.Web.Services.Interfaces
@inject NavigationManager Navigation

<PageTitle>Deleted Images - CareFusion</PageTitle>

<div class="deleted-images-container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2>Deleted Images</h2>
            <p class="text-muted">Manage soft-deleted image files and restore if needed</p>
        </div>
        <button class="btn btn-outline-danger" @onclick="ShowPurgeModal">
            <i class="bi bi-trash3"></i> Purge All
        </button>
    </div>

    <div class="filters-section mb-4">
        <div class="row">
            <div class="col-md-6">
                <input type="text" class="form-control search-input" placeholder="Search by filename or patient name" @bind="searchTerm" @oninput="OnSearchTermChanged" />
            </div>
            <div class="col-md-3">
                <select class="form-select" @bind="selectedTimeFilter" @bind:after="FilterImages">
                    <option value="all">All Time</option>
                    <option value="today">Today</option>
                    <option value="week">This Week</option>
                    <option value="month">This Month</option>
                    <option value="year">This Year</option>
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-select" @bind="selectedDeletedBy" @bind:after="FilterImages">
                    <option value="all">Deleted By Anyone</option>
                    <option value="current">Deleted By Me</option>
                    <option value="system">System Deleted</option>
                </select>
            </div>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading deleted images...</p>
        </div>
    }
    else if (filteredImages.Any())
    {
        <div class="results-summary mb-3">
            <span class="text-muted">Showing @filteredImages.Count of @deletedImages.Count deleted images</span>
        </div>

        <div class="images-grid">
            @foreach (var image in filteredImages)
            {
                <div class="image-card">
                    <div class="image-thumbnail">
                        <img src="@(image.ThumbnailPath ?? image.FilePath)" 
                             alt="@image.FileName" 
                             class="thumbnail-img"
                             onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDEwMCAxMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjEwMCIgaGVpZ2h0PSIxMDAiIGZpbGw9IiNGNUY1RjUiLz48cGF0aCBkPSJNMjUgMjVIMTBWNzVIODBWNDBINjVWNTVINDBWNDBIMjVWMjVaIiBmaWxsPSIjQ0NDQ0NDIi8+PC9zdmc+'" />
                        <div class="overlay">
                            <button class="btn btn-sm btn-outline-light me-2" @onclick="() => RestoreImage(image.Id)" title="Restore Image">
                                <i class="bi bi-arrow-counterclockwise"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-light" @onclick="() => PreviewImage(image)" title="Preview Image">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="image-info">
                        <div class="image-filename">@image.FileName</div>
                        <div class="image-details">
                            <small class="text-muted">
                                <div><strong>Patient:</strong> @(image.PatientName ?? "Unknown")</div>
                                <div><strong>Exam Date:</strong> @(image.ExamDate?.ToString("MM/dd/yyyy") ?? "N/A")</div>
                                <div><strong>Size:</strong> @image.FileSizeFormatted</div>
                                <div><strong>Deleted:</strong> @image.ModifiedAtUtc?.ToString("MM/dd/yyyy h:mm tt")</div>
                                <div><strong>Deleted By:</strong> @(image.ModifiedBy ?? "Unknown")</div>
                            </small>
                        </div>
                    </div>
                    
                    <div class="image-actions">
                        <button class="btn btn-success btn-sm me-2" @onclick="() => RestoreImage(image.Id)" title="Restore Image">
                            <i class="bi bi-arrow-counterclockwise"></i> Restore
                        </button>
                        <button class="btn btn-outline-danger btn-sm" @onclick="() => PermanentDelete(image.Id)" title="Permanently Delete">
                            <i class="bi bi-trash3"></i> Delete
                        </button>
                    </div>
                </div>
            }
        </div>

        <div class="pagination-section mt-4 d-flex justify-content-between align-items-center">
            <div class="bulk-actions">
                <button class="btn btn-success me-2" @onclick="RestoreSelected" disabled="@(!selectedImages.Any())">
                    <i class="bi bi-arrow-counterclockwise"></i> Restore Selected (@selectedImages.Count)
                </button>
                <button class="btn btn-outline-danger" @onclick="PurgeSelected" disabled="@(!selectedImages.Any())">
                    <i class="bi bi-trash3"></i> Delete Selected (@selectedImages.Count)
                </button>
            </div>
        </div>
    }
    else
    {
        <div class="text-center text-muted py-5">
            <i class="bi bi-inbox display-4"></i>
            <h4 class="mt-3">No Deleted Images Found</h4>
            <p>@(string.IsNullOrWhiteSpace(searchTerm) ? "There are no deleted images in the system." : "No deleted images match your search criteria.")</p>
        </div>
    }
</div>

<style>
    .deleted-images-container {
        padding: 20px;
    }

    .search-input {
        border-bottom: 2px solid #007bff;
        border-radius: 0;
        border-top: none;
        border-left: none;
        border-right: none;
        box-shadow: none;
        padding-left: 0;
    }

    .search-input:focus {
        border-bottom-color: #0056b3;
        box-shadow: none;
    }

    .images-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
    }

    .image-card {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        background-color: white;
        transition: box-shadow 0.2s ease;
    }

    .image-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .image-thumbnail {
        position: relative;
        width: 100%;
        height: 180px;
        border-radius: 6px;
        overflow: hidden;
        margin-bottom: 10px;
        background-color: #f8f9fa;
    }

    .thumbnail-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        opacity: 0;
        transition: opacity 0.2s ease;
    }

    .image-thumbnail:hover .overlay {
        opacity: 1;
    }

    .image-filename {
        font-weight: 600;
        color: #333;
        margin-bottom: 8px;
        font-size: 14px;
        word-break: break-word;
    }

    .image-details {
        margin-bottom: 15px;
        font-size: 12px;
        line-height: 1.4;
    }

    .image-details div {
        margin-bottom: 2px;
    }

    .image-actions {
        display: flex;
        gap: 8px;
        justify-content: center;
    }

    .btn-sm {
        font-size: 12px;
        padding: 6px 12px;
    }

    .filters-section .form-select,
    .filters-section .form-control {
        border-radius: 6px;
    }

    .results-summary {
        font-size: 14px;
        padding: 10px 0;
    }

    .bulk-actions {
        display: flex;
        align-items: center;
    }
</style>

@code {
    private List<ExamImageDto> deletedImages = new();
    private List<ExamImageDto> filteredImages = new();
    private List<int> selectedImages = new();
    private string searchTerm = "";
    private string selectedTimeFilter = "all";
    private string selectedDeletedBy = "all";
    private bool isLoading = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadDeletedImages();
    }

    private async Task LoadDeletedImages()
    {
        try
        {
            isLoading = true;
            StateHasChanged();

            // TODO: Load deleted images from service
            // For now, using sample data
            deletedImages = new List<ExamImageDto>
            {
                new()
                {
                    Id = 1,
                    ExamId = 1,
                    FileName = "chest_xray_001.jpg",
                    FileSizeBytes = 2048576,
                    FileSizeFormatted = "2.0 MB",
                    ContentType = "image/jpeg",
                    FilePath = "/images/chest_xray_001.jpg",
                    ThumbnailPath = "/thumbnails/chest_xray_001_thumb.jpg",
                    Width = 1920,
                    Height = 1080,
                    UploadDate = DateTime.Now.AddDays(-10),
                    UploadedBy = "Dr. Smith",
                    CreatedAtUtc = DateTime.Now.AddDays(-10),
                    ModifiedAtUtc = DateTime.Now.AddDays(-2),
                    ModifiedBy = "Dr. Johnson",
                    IsDeleted = true,
                    PatientName = "John Doe",
                    ExamDate = DateTime.Now.AddDays(-10)
                }
            };

            FilterImages();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading deleted images: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void OnSearchTermChanged(ChangeEventArgs e)
    {
        searchTerm = e.Value?.ToString() ?? "";
        FilterImages();
    }

    private void FilterImages()
    {
        var filtered = deletedImages.AsQueryable();

        // Apply search filter
        if (!string.IsNullOrWhiteSpace(searchTerm))
        {
            filtered = filtered.Where(i => 
                i.FileName.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                (i.PatientName ?? "").Contains(searchTerm, StringComparison.OrdinalIgnoreCase));
        }

        // Apply time filter
        if (selectedTimeFilter != "all")
        {
            var now = DateTime.Now;
            switch (selectedTimeFilter)
            {
                case "today":
                    filtered = filtered.Where(i => i.ModifiedAtUtc.HasValue && i.ModifiedAtUtc.Value.Date == now.Date);
                    break;
                case "week":
                    var weekStart = now.AddDays(-(int)now.DayOfWeek);
                    filtered = filtered.Where(i => i.ModifiedAtUtc.HasValue && i.ModifiedAtUtc.Value >= weekStart);
                    break;
                case "month":
                    var monthStart = new DateTime(now.Year, now.Month, 1);
                    filtered = filtered.Where(i => i.ModifiedAtUtc.HasValue && i.ModifiedAtUtc.Value >= monthStart);
                    break;
                case "year":
                    var yearStart = new DateTime(now.Year, 1, 1);
                    filtered = filtered.Where(i => i.ModifiedAtUtc.HasValue && i.ModifiedAtUtc.Value >= yearStart);
                    break;
            }
        }

        // Apply deleted by filter
        if (selectedDeletedBy != "all")
        {
            switch (selectedDeletedBy)
            {
                case "current":
                    filtered = filtered.Where(i => i.ModifiedBy == "Current User"); // In real app, use actual current user
                    break;
                case "system":
                    filtered = filtered.Where(i => i.ModifiedBy == "System");
                    break;
            }
        }

        filteredImages = filtered.ToList();
        StateHasChanged();
    }

    private async Task RestoreImage(int imageId)
    {
        try
        {
            // TODO: In real implementation, call API to restore image
            var image = deletedImages.FirstOrDefault(i => i.Id == imageId);
            if (image != null)
            {
                deletedImages.Remove(image);
                FilterImages();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error restoring image: {ex.Message}");
        }
    }

    private async Task RestoreSelected()
    {
        try
        {
            // TODO: In real implementation, call API to restore selected images
            var imagesToRestore = deletedImages.Where(i => selectedImages.Contains(i.Id)).ToList();
            foreach (var image in imagesToRestore)
            {
                deletedImages.Remove(image);
            }
            selectedImages.Clear();
            FilterImages();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error restoring selected images: {ex.Message}");
        }
    }

    private async Task PermanentDelete(int imageId)
    {
        try
        {
            // TODO: In real implementation, call API to permanently delete image
            var image = deletedImages.FirstOrDefault(i => i.Id == imageId);
            if (image != null)
            {
                deletedImages.Remove(image);
                FilterImages();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error permanently deleting image: {ex.Message}");
        }
    }

    private async Task PurgeSelected()
    {
        try
        {
            // TODO: In real implementation, call API to permanently delete selected images
            var imagesToPurge = deletedImages.Where(i => selectedImages.Contains(i.Id)).ToList();
            foreach (var image in imagesToPurge)
            {
                deletedImages.Remove(image);
            }
            selectedImages.Clear();
            FilterImages();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error purging selected images: {ex.Message}");
        }
    }

    private void PreviewImage(ExamImageDto image)
    {
        // TODO: Open image preview modal
        Console.WriteLine($"Preview image: {image.FileName}");
    }

    private void ShowPurgeModal()
    {
        // TODO: In real implementation, show confirmation modal
        Console.WriteLine("Show purge all confirmation modal");
    }
}