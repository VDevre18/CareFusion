@page "/manage-account"
@attribute [Authorize]

<PageTitle>Manage Account - CareFusion</PageTitle>

<div class="manage-account-container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2>Manage Account</h2>
            <p class="text-muted">Update your personal information and security settings</p>
        </div>
        <div class="account-status">
            <span class="badge bg-success">
                <i class="bi bi-check-circle me-1"></i>Active Account
            </span>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <!-- Profile Information Section -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-person me-2"></i>Profile Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label class="form-label">Username</label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="bi bi-person-circle"></i>
                                    </span>
                                    <input type="text" class="form-control" @bind="username" readonly />
                                </div>
                                <small class="text-muted">Your username cannot be changed</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label class="form-label">Full Name</label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="bi bi-person"></i>
                                    </span>
                                    <input type="text" class="form-control" @bind="name" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label class="form-label">Email Address</label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="bi bi-envelope"></i>
                                    </span>
                                    <input type="email" class="form-control" @bind="email" />
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label class="form-label">Phone Number</label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="bi bi-telephone"></i>
                                    </span>
                                    <input type="tel" class="form-control" @bind="phone" placeholder="(555) 123-4567" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label class="form-label">Department</label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="bi bi-building"></i>
                                    </span>
                                    <input type="text" class="form-control" @bind="department" />
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label class="form-label">Role</label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="bi bi-shield-check"></i>
                                    </span>
                                    <input type="text" class="form-control" @bind="role" readonly />
                                </div>
                                <small class="text-muted">Contact administrator to change your role</small>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-end">
                        <button class="btn btn-primary" @onclick="UpdateProfile" disabled="@isUpdatingProfile">
                            @if (isUpdatingProfile)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                            }
                            <i class="bi bi-check-circle me-1"></i>Update Profile
                        </button>
                    </div>
                </div>
            </div>

            <!-- Security Section -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-shield-lock me-2"></i>Security Settings
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label class="form-label">Current Password</label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="bi bi-lock"></i>
                                    </span>
                                    <input type="password" class="form-control" @bind="currentPassword" placeholder="Enter current password" />
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="password-requirements">
                                <small class="text-muted">Password Requirements:</small>
                                <ul class="password-rules">
                                    <li class="@(passwordRules.MinLength ? "text-success" : "text-muted")">
                                        <i class="bi @(passwordRules.MinLength ? "bi-check" : "bi-dash")"></i>
                                        At least 8 characters
                                    </li>
                                    <li class="@(passwordRules.HasUpper ? "text-success" : "text-muted")">
                                        <i class="bi @(passwordRules.HasUpper ? "bi-check" : "bi-dash")"></i>
                                        One uppercase letter
                                    </li>
                                    <li class="@(passwordRules.HasNumber ? "text-success" : "text-muted")">
                                        <i class="bi @(passwordRules.HasNumber ? "bi-check" : "bi-dash")"></i>
                                        One number
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label class="form-label">New Password</label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="bi bi-key"></i>
                                    </span>
                                    <input type="password" class="form-control" @bind="newPassword" @bind:after="ValidatePassword" placeholder="Enter new password" />
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label class="form-label">Confirm New Password</label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="bi bi-key-fill"></i>
                                    </span>
                                    <input type="password" class="form-control" @bind="confirmPassword" placeholder="Confirm new password" />
                                </div>
                                @if (!string.IsNullOrEmpty(newPassword) && !string.IsNullOrEmpty(confirmPassword) && newPassword != confirmPassword)
                                {
                                    <small class="text-danger">Passwords do not match</small>
                                }
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-end">
                        <button class="btn btn-warning" @onclick="UpdatePassword" disabled="@(!CanUpdatePassword() || isUpdatingPassword)">
                            @if (isUpdatingPassword)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                            }
                            <i class="bi bi-shield-check me-1"></i>Update Password
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Account Summary Sidebar -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-info-circle me-2"></i>Account Summary
                    </h5>
                </div>
                <div class="card-body">
                    <div class="summary-item">
                        <strong>Account Created:</strong>
                        <span>@accountCreated.ToString("MMM dd, yyyy")</span>
                    </div>
                    <div class="summary-item">
                        <strong>Last Login:</strong>
                        <span>@lastLogin.ToString("MMM dd, yyyy h:mm tt")</span>
                    </div>
                    <div class="summary-item">
                        <strong>Password Last Changed:</strong>
                        <span>@passwordChanged.ToString("MMM dd, yyyy")</span>
                    </div>
                    <div class="summary-item">
                        <strong>Total Logins:</strong>
                        <span>@totalLogins</span>
                    </div>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-gear me-2"></i>Quick Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-download me-1"></i>Download Data
                        </button>
                        <button class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-clipboard me-1"></i>Activity Log
                        </button>
                        <button class="btn btn-outline-danger btn-sm">
                            <i class="bi bi-box-arrow-right me-1"></i>Sign Out All Devices
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .manage-account-container {
        padding: 20px;
        max-width: 1200px;
    }

    .form-group .input-group-text {
        background-color: #f8f9fa;
        border-right: none;
        color: #6c757d;
    }

    .form-group .form-control {
        border-left: none;
    }

    .form-group .form-control:focus {
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        border-color: #80bdff;
    }

    .form-group .form-control:focus + .input-group-text {
        border-color: #80bdff;
    }

    .password-requirements {
        margin-top: 8px;
    }

    .password-rules {
        list-style: none;
        padding-left: 0;
        margin-bottom: 0;
        font-size: 12px;
    }

    .password-rules li {
        margin-bottom: 4px;
    }

    .summary-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 12px;
        padding-bottom: 8px;
        border-bottom: 1px solid #f0f0f0;
    }

    .summary-item:last-child {
        border-bottom: none;
        margin-bottom: 0;
    }

    .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
    }

    .account-status .badge {
        font-size: 14px;
        padding: 8px 12px;
    }

    .btn-sm {
        font-size: 14px;
    }
</style>

@code {
    private string username = "VDev";
    private string name = "Vatsal";
    private string email = "vdevre@cellviewimaging.com";
    private string phone = "";
    private string department = "IT Administration";
    private string role = "Administrator";

    private string currentPassword = "";
    private string newPassword = "";
    private string confirmPassword = "";

    private bool isUpdatingProfile = false;
    private bool isUpdatingPassword = false;

    private DateTime accountCreated = DateTime.Now.AddYears(-2);
    private DateTime lastLogin = DateTime.Now.AddHours(-2);
    private DateTime passwordChanged = DateTime.Now.AddMonths(-3);
    private int totalLogins = 247;

    private PasswordRules passwordRules = new();

    protected override void OnInitialized()
    {
        ValidatePassword();
    }

    private async Task UpdateProfile()
    {
        isUpdatingProfile = true;
        StateHasChanged();

        try
        {
            // Simulate API call
            await Task.Delay(1500);
            
            // In real implementation, call API to update profile
            Console.WriteLine("Profile updated successfully");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error updating profile: {ex.Message}");
        }
        finally
        {
            isUpdatingProfile = false;
            StateHasChanged();
        }
    }

    private async Task UpdatePassword()
    {
        if (!CanUpdatePassword())
            return;

        isUpdatingPassword = true;
        StateHasChanged();

        try
        {
            // Simulate API call
            await Task.Delay(2000);
            
            // In real implementation, call API to update password
            Console.WriteLine("Password updated successfully");
            
            // Clear password fields
            currentPassword = "";
            newPassword = "";
            confirmPassword = "";
            passwordChanged = DateTime.Now;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error updating password: {ex.Message}");
        }
        finally
        {
            isUpdatingPassword = false;
            StateHasChanged();
        }
    }

    private void ValidatePassword()
    {
        passwordRules.MinLength = newPassword.Length >= 8;
        passwordRules.HasUpper = newPassword.Any(char.IsUpper);
        passwordRules.HasNumber = newPassword.Any(char.IsDigit);
        StateHasChanged();
    }

    private bool CanUpdatePassword()
    {
        return !string.IsNullOrWhiteSpace(currentPassword) &&
               !string.IsNullOrWhiteSpace(newPassword) &&
               !string.IsNullOrWhiteSpace(confirmPassword) &&
               newPassword == confirmPassword &&
               passwordRules.IsValid;
    }

    private class PasswordRules
    {
        public bool MinLength { get; set; }
        public bool HasUpper { get; set; }
        public bool HasNumber { get; set; }
        public bool IsValid => MinLength && HasUpper && HasNumber;
    }
}
